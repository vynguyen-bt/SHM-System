<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SHM - BIM</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Unified CSS for consistent design system -->
    <link rel="stylesheet" href="css/unified.css" />
    <style>
      /* Tối ưu hiệu suất canvas cho Plotly */
      canvas {
        will-change: auto;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: optimize-contrast;
      }

      /* Lăn mượt khi nhảy đến các mục */
      html { scroll-behavior: smooth; }


      /* Chừa khoảng trống cho thanh điều hướng cố định */
      body.has-quick-nav { padding-top: 56px; }


      #damage3DChart {
        max-width: 100%;
        height: auto;
      }

      /* Ẩn/hiện chung */
      .is-hidden { display: none !important; }

      /* Menu Tùy chọn hiển thị */
      .ui-visibility-wrap { position: relative; display: inline-block; float: right; }
      #ui-visibility-toggle-btn { white-space: nowrap; }
      #ui-visibility-menu {
        position: absolute;
        right: 0;
        top: 100%;
        z-index: 1000;
        min-width: 260px;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 8px 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,.08);
        display: none;
        max-height: 60vh;
        overflow: auto;
      }
      #ui-visibility-menu label { display: flex; align-items: center; gap: 8px; margin: 6px 0; }



      /* Phần B — Ẩn mặc định nội dung các mục (tránh FOUC), toggle JS sẽ bật khi người dùng bấm */
      .main-part > .body-part {
        display: none;               /* không dùng !important để JS có thể hiển thị lại */
      }
    </style>

    <script>
      // Áp dụng CSS ẩn ngay khi tải (tránh FOUC)
      (function(){
        try {
          const getBool = (v) => v === 'true' || v === true;
          const abHidden = getBool(localStorage.getItem('shm.ui.hide.actionButtons'));
          const css = [];
          if (abHidden) css.push('#batch-download-btn,#export-abc-csv-btn,#export-all-modes-damage-list-btn,#download-2d-image-btn,#download-3d-chart-btn-section1,#download-3d-chart-btn-section1-normalized,#download-3d-chart-btn-section1-both,#download-charts-btn,#download-charts-test-csv-btn{display:none!important}');
          if (css.length){
            const st = document.createElement('style'); st.textContent = css.join('\n'); document.head.appendChild(st);
          }
        } catch(e) {}
      })();
    </script>
    <script src="js/ui_visibility_toggle.js?v=ui_vis_v1"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <!-- Three.js updated to latest version with ES modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <script>
      // Chế độ mật độ giao diện: compact/tight
      // Key mới: 'shm.ui.densityLevel' = 'normal' | 'compact' | 'tight'
      (function(){
        try {
          var level = localStorage.getItem('shm.ui.densityLevel');
          // Mặc định dùng 'tight' để giảm chiều cao tối đa
          if (level === null) level = 'tight';
          function applyLevel(lv){
            var isCompact = (lv === 'compact' || lv === 'tight');
            var isTight = (lv === 'tight');
            document.body.classList.toggle('density-compact', isCompact);
            document.body.classList.toggle('tight', isTight);
          }
          document.addEventListener('DOMContentLoaded', function(){ applyLevel(level); });
          // API công khai để đổi nhanh
          window.setDensityLevel = function(lv){
            if (!lv) return;
            localStorage.setItem('shm.ui.densityLevel', lv);
            applyLevel(lv);
          };
          // Tương thích hàm cũ setDensityMode('compact'|'normal')
          window.setDensityMode = function(mode){
            var lv = (mode === 'compact') ? 'compact' : 'normal';
            localStorage.setItem('shm.ui.densityLevel', lv);
            applyLevel(lv);
          };
        } catch(e) {}
      })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body class="density-compact has-quick-nav">
    <h1>HỆ THỐNG SHM PHÂN TÍCH</h1>
    <!-- Nút sổ/thu gọn tất cả mục -->
    <div class="container" style="margin: 10px 0;">
    <!-- Thanh điều hướng nhanh tới các mục -->
    <div class="container-fluid" id="quick-nav" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: #fff; padding: 6px 12px; border-bottom: 1px solid #dee2e6; width: 100%;">
      <span style="margin-right: 8px; font-weight: 600;">Đi tới:</span>
      <button class="btn btn-outline-secondary btn-sm" onclick="jumpTo('partB1','switchToPartB1')">0</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="jumpTo('partA','switchToPartA')">1</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="jumpTo('partVR','openVRViewer')">5</button>
    </div>

    <script>
      // Cuộn mượt tới khu vực có id, tự mở mục nếu đang bị ẩn
      function jumpTo(targetId, openFnName){
        try {
          var el = document.getElementById(targetId);
          if (!el) return;
          var isHidden = window.getComputedStyle(el).display === 'none';
          if (isHidden && typeof window[openFnName] === 'function') {
            // Gọi hàm mở mục nếu có (các hàm hiện có là kiểu toggle)
            window[openFnName]();
          }
          // Dùng setTimeout để đảm bảo mục đã mở xong trước khi cuộn
          setTimeout(function(){
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 50);
        } catch(e) {
          // Bỏ qua lỗi im lặng để không ảnh hưởng UX
        }
      }
    </script>

      <button id="toggle-all-sections-btn" class="btn btn-outline-secondary btn-sm" onclick="toggleAllSections()">
        Sổ ra tất cả mục
      </button>
    </div>
    <div class="main-part">
      <button onclick="switchToPartB1()" class="button-open">
        0. Mô phỏng hư hỏng
      </button>
      <div class="body-part">
        <div id="partB1">
          <div class="container">
            <h1>0. Mô phỏng hư hỏng</h1>
            <label for="txt-file-delta-x" style="display: none"
              >Tải tệp thông tin phần tử (TXT file):</label
            >
            <input
              type="file"
              id="txt-file-delta-x"
              accept=".txt"
              onchange="readDeltaX()"
              style="display: none"
            />
            <label for="folder-input"
              ><strong>Tải thư mục dữ liệu:</strong></label

            >
            <input
              type="file"
              id="folder-input"
              webkitdirectory
              directory
              multiple
            />
            <div class="row">
              <!-- Cột cho Phần tử 1 -->
              <div class="col-md-4">
                <div class="form-group">
                  <label for="survey-index"><strong>Nhập phần tử mô phỏng 1:</strong></label>
                  <input type="number" id="survey-index" class="form-control" min="1" />
                </div>
                <div class="form-group">
                  <label for="damage-value"><strong>Nhập mức độ hư hỏng 1 (%):</strong></label>
                  <input type="number" id="damage-value" class="form-control" min="0" />
                </div>
              </div>
              <!-- Cột cho Phần tử 2 -->
              <div class="col-md-4">
                <div class="form-group">
                  <label for="survey-index2"><strong>Nhập phần tử mô phỏng 2:</strong></label>
                  <input type="number" id="survey-index2" class="form-control" min="1" />
                </div>
                <div class="form-group">
                  <label for="damage-value2"><strong>Nhập mức độ hư hỏng 2 (%):</strong></label>
                  <input type="number" id="damage-value2" class="form-control" min="0" />
                </div>
              </div>
              <!-- Cột cho Phần tử 3 -->
              <div class="col-md-4">
                <div class="form-group">
                  <label for="survey-index3"><strong>Nhập phần tử mô phỏng 3:</strong></label>
                  <input type="number" id="survey-index3" class="form-control" min="1" />
                </div>
                <div class="form-group">
                  <label for="damage-value3"><strong>Nhập mức độ hư hỏng 3 (%):</strong></label>
                  <input type="number" id="damage-value3" class="form-control" min="0" />
                </div>
              </div>
            </div>
            <button onclick="exportValue()" class="btn btn-primary mt-3">Xuất dữ liệu</button>
          </div>
        </div>
      </div>
    </div>
    <div class="main-part">
      <button onclick="switchToPartA()" class="button-open">
        1. Phát hiện vị trí hư hỏng bằng phương pháp hiệu độ cong dạng dao động
      </button>
      <div class="body-part">
        <div id="partA">
          <div class="container">
            <h1>1. Phát hiện vị trí hư hỏng bằng phương pháp hiệu độ cong dạng dao động</h1>
            <label for="txt-file-non-damaged" style="display: none"
              >Tải dữ liệu dạng dao động (Không hư hỏng, TXT file):</label
            >
            <input
              type="file"
              id="txt-file-non-damaged"
              accept=".txt"
              style="display: none"
            />
            <label for="txt-file-damaged" style="display: none"
              >Tải dữ liệu dạng dao động (Hư hỏng, TXT file):</label
            >
            <input
              type="file"
              id="txt-file-damaged"
              accept=".txt"
              style="display: none"
            />
            <input
              type="file"
              id="txt-file-simulation"
              accept=".txt"
              style="display: none"
            />
            <h2>Thông số chẩn đoán</h2>
            <label for="mode-number"
              ><strong>Chọn Mode khảo sát:</strong></label
            >
            <select id="mode-number">
              <option value="1">Mode 1</option>
              <option value="2">Mode 2</option>
              <option value="3">Mode 3</option>
              <option value="4">Mode 4</option>
              <option value="5">Mode 5</option>
              <option value="6">Mode 6</option>
              <option value="7">Mode 7</option>
              <option value="8">Mode 8</option>
              <option value="9">Mode 9</option>
              <option value="10">Mode 10</option>
              <option value="11">Mode 11</option>
              <option value="12">Mode 12</option>
              <option value="13">Mode 13</option>
              <option value="14">Mode 14</option>
              <option value="15">Mode 15</option>
              <option value="16">Mode 16</option>
              <option value="17">Mode 17</option>
              <option value="18">Mode 18</option>
              <option value="19">Mode 19</option>
              <option value="20">Mode 20</option>
              <option value="combine">Mode CB</option>
            </select>
            <label for="curvature-multiplier"
              ><strong>Nhập ngưỡng hư hỏng Z₀ (% giá trị Z lớn nhất):</strong></label
            >
            <!-- Đổi từ input number sang select cố định các mức Z₀; giữ nguyên id để tương thích code hiện tại -->
            <select id="curvature-multiplier">
              <option value="10">10%</option>
              <option value="20">20%</option>
              <option value="30">30%</option>
              <option value="40" selected>40%</option>
              <option value="50">50%</option>
              <option value="60">60%</option>
            </select>
            <input
              type="number"
              id="poisson-ratio"
              value="0.2"
              step="0.01"
              min="0"
              max="0.5"
              style="display: none;"
            />
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="element-y"><strong>Nhập phần tử khảo sát 1:</strong></label>
                  <input type="number" id="element-y" value="55" step="any" min="1" class="form-control" />
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="element-y-2"><strong>Nhập phần tử khảo sát 2:</strong></label>
                  <input type="number" id="element-y-2" value="" step="any" min="1" class="form-control" />
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="element-y-3"><strong>Nhập phần tử khảo sát 3:</strong></label>
                  <input type="number" id="element-y-3" value="" step="any" min="1" class="form-control" />
                </div>
              </div>
            </div>
            <br />
            <div id="input-container" style="display: none">
              <label for="train-value">Giá trị huấn luyện đầu tiên:</label>
              <input type="number" id="train-value" value="0" step="0.1" />
              <label for="step-value">Bước nhảy:</label>
              <input type="number" id="step-value" value="3" step="0.1" />
            </div>
            <button onclick="runCalculationsTwice()" class="btn btn-primary" id="btn-run-calc-section1">Tính toán</button>
            <button onclick="calculateAllMACs()" style="background-color: #17a2b8; color: white; margin-top: 10px;">Tính MAC</button>

            <div id="mac-results" style="margin-top: 20px;">
              <table id="mac-table" class="table" style="display: none;">
                <thead>
                  <tr>
                    <th>Mode</th>
                    <th>Chỉ số MAC</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Results will be inserted here by JavaScript -->
                </tbody>
              </table>
            </div>



            <button onclick="downloadMultiMode3DCharts()" id="download-charts-btn" style="background-color: #28a745; color: white; margin-top: 10px; display: none !important;">Download Multi-Mode 3D Charts</button>
            <button onclick="downloadMultiMode3DChartsTestCSV()" id="download-charts-test-csv-btn" style="background-color: #17a2b8; color: white; margin-top: 10px; display: none !important;">Download Multi-3D (TEST.csv Based)</button>







            <div id="download-progress" style="margin-top: 10px; display: none;">
              <div style="background-color: #f0f0f0; border-radius: 5px; padding: 10px;">
                <div id="progress-text">Preparing download...</div>
                <div style="background-color: #ddd; border-radius: 10px; margin-top: 5px;">
                  <div id="progress-bar" style="background-color: #28a745; height: 20px; border-radius: 10px; width: 0%; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>
            <div id="excel-progress" style="margin-top: 10px; display: none;">
              <div style="background-color: #e8f5e8; border-radius: 5px; padding: 10px; border: 1px solid #198754;">
                <div id="excel-progress-text">Calculating metrics for all combinations...</div>
                <div style="background-color: #ddd; border-radius: 10px; margin-top: 5px;">
                  <div id="excel-progress-bar" style="background-color: #198754; height: 20px; border-radius: 10px; width: 0%; transition: width 0.3s;"></div>
                            <!-- Threshold Slider -->
                            <div class="row mt-3 align-items-center">
                                <div class="col-md-12">
                                    <label for="threshold-slider" class="form-label fw-bold">DI Threshold: <span id="threshold-value" class="badge bg-secondary">0.01</span></label>
                                    <input type="range" class="form-range" id="threshold-slider" min="0" max="0.5" step="0.005" value="0.01">
                                </div>
                            </div>
                </div>
                <div id="excel-progress-details" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
              </div>
            </div>
            <div id="results"></div>
            <div id="damage3DChart" style="width:1200px; height:900px; display: none;"></div>
            <div id="new3DChart_section1" style="width:1000px; height:600px; margin-top: 10px;"></div>
            <button class="btn btn-success" id="download-3d-chart-btn-section1" onclick="downloadChart3D(1, { variant: 'default' })" style="display: none; margin-top: 10px;">Tải xuống biểu đồ 3D</button>
            <div id="normalized3DChart_section1" style="width:1000px; height:600px; margin-top: 10px;"></div>
            <button class="btn btn-success" id="download-3d-chart-btn-section1-normalized" onclick="downloadChart3D(1, { variant: 'normalized' })" style="display: none; margin-top: 10px;">Tải xuống biểu đồ 3D (Chuẩn hóa)</button>
            <button class="btn btn-success" id="download-3d-chart-btn-section1-both" onclick="downloadBothChartsSection1()" style="display: none; margin-top: 10px;">Tải xuống cả hai biểu đồ 3D</button>
            <button class="btn btn-primary" id="batch-download-btn" onclick="runBatchDownload()" style="margin-top: 10px;">Tải 5 ngưỡng (10-50%)</button>
            <button class="btn btn-info" id="export-abc-csv-btn" onclick="exportABC_CSV()" style="margin-top: 10px;">Xuất báo cáo CSV (A, B, C)</button>
          </div>
        </div>
      </div>
    </div>
    <div class="main-part">
      <button onclick="openVRViewer()" class="button-open">
        5. Mô hình VR tích hợp Digital Twin
      </button>
      <div class="body-part">
        <div id="partVR" class="body-part" style="display: none;">
          <div class="container">
            <h1>5. Mô hình VR tích hợp Digital Twin</h1>

            <button onclick="openVRViewerWindow()" class="btn btn-primary" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 10px 5px;">
              Mở trình xem VR
            </button>
            <button onclick="openVRViewerNewTab()" class="btn btn-secondary" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 10px 5px;">
              Mở trong cửa sổ mới
            </button>

          </div>
        </div>
      </div>
    </div>
    <script src="js/switch.js"></script>
    <script src="js/new3DPlot.js"></script>
    <script src="js/calculations.js?v=SRSS_fix_4_csv_recalc"></script>


    <!-- ✅ EMERGENCY FIX: Ensure switchToPartB1 function exists -->
    <script>
      // Emergency fallback for switchToPartB1
      if (typeof switchToPartB1 === 'undefined') {


        function switchToPartB1() {

          var partB1 = document.getElementById("partB1");
          if (partB1) {
            partB1.style.display = partB1.style.display === "block" ? "none" : "block";

          } else {

          }
        }

        // Make it globally available
        window.switchToPartB1 = switchToPartB1;

      } else {

      }

      // VR Viewer functions
      function openVRViewer() {
        var partVR = document.getElementById("partVR");
        if (partVR) {
          partVR.style.display = partVR.style.display === "block" ? "none" : "block";
        }
      }

      function openVRViewerWindow() {
        // Navigate to VR viewer in current window
        window.location.href = 'http://localhost:8080/app/index.html?projectId=SHM_STR_UPDATED';
      }

      function openVRViewerNewTab() {
        // Open VR viewer in new tab
        window.open('http://localhost:8080/app/index.html?projectId=SHM_STR_UPDATED', '_blank');
      }

      // Make functions globally available
      window.openVRViewer = openVRViewer;
      window.openVRViewerWindow = openVRViewerWindow;
      window.openVRViewerNewTab = openVRViewerNewTab;

    </script>
    <script src="js/fileHandling.js?v=final_cleanup"></script>
    <script src="js/chartProcessing.js?v=final_cleanup"></script>
    <script src="js/simulation_parser.js?v=final_cleanup"></script>
    <!-- 3D Chart Download Feature -->
    <script src="js/download_3d_chart.js?v=download_v8"></script>
    <!-- Toggle all sections feature -->
    <script src="js/toggle_sections.js?v=toggle_v1"></script>


    <!-- Disabled all non-essential and debug scripts to prevent conflicts -->
    <!--
    <script src="js/di_values_fix.js"></script>
    <script src="js/silent_csv_fix.js"></script>
    <script src="js/test_train_csv.js"></script>
    <script src="js/integrated_csv_generator.js"></script>
    <script src="js/safe_csv_wrapper.js"></script>
    <script src="js/enhanced_train_csv.js"></script>
    <script src="js/integrated_dynamic_csv.js"></script>
    <script src="js/fallback_csv_generator.js"></script>
    <script src="js/test_training_case_detection.js"></script>
    <script src="js/dynamic_csv_interface.js"></script>
    <script src="js/immediate_toggle_test.js"></script>
    <script src="js/test_section_layout.js"></script>
    <script src="js/test_text_alignment.js"></script>
    <script src="js/debug_mode_combine_225.js"></script>
    <script src="js/test_damage_txt_integration.js"></script>
    <script src="js/analyze_section2_data_requirements.js"></script>
    <script src="js/show_test_csv_format.js"></script>
    <script src="js/test_simulation_mapping.js"></script>
    <script src="js/debug_uz_values.js"></script>
    <script src="js/test_element_40_di3.js"></script>
    <script src="js/test_dynamic_csv_format.js"></script>
    <script src="js/debug_section2_button.js"></script>
    <script src="js/verify_section2_fixes.js"></script>
    <script src="js/force_function_reload.js"></script>
    <script src="js/debug_damage_txt_parsing.js"></script>
    <script src="js/test_improved_scaling.js"></script>
    <script src="js/test_damage_txt_parsing.js"></script>
    <script src="js/verify_csv_values.js"></script>
    <script src="js/debug_csv_data_flow.js"></script>
    <script src="js/fix_csv_generation.js"></script>
    <script src="js/test_csv_fix.js"></script>
    <script src="js/trace_csv_generation.js"></script>
    <script src="js/emergency_csv_fix.js"></script>
    <script src="js/raw_values_csv_fix.js"></script>
    <script src="js/test_raw_values.js"></script>
    <script src="js/immediate_raw_fix.js"></script>
    <script src="js/apply_immediate_fix.js"></script>
    <script src="js/quick_fix.js"></script>
    <script src="js/test_di_calculation.js"></script>
    -->

    <!-- Debug tools available in console if needed -->
    <script>
      window.addEventListener('load', function() {
        // Debug tools are loaded and available in console:
        // - createImmediateFixReport() - Test toggle functions
        // - createLayoutTestReport() - Test section layout
        // - createTextAlignmentReport() - Test text alignment


      });
    </script>

    <script>
      function callNew3DPlotForSection1() {
        if (!window.strainEnergyResults) return; // Exit if no data
        // The Z0 value is already inside window.strainEnergyResults
        drawStyled3DBarChart('new3DChart_section1', window.strainEnergyResults, 'Biểu đồ 3D - Vị trí hư hỏng', { showPercentages: false, zAxisRange: [0, 10], zAspect: 1 });
      }

      function callNormalized3DPlotForSection1() {
        if (!window.strainEnergyResults) return; // Exit if no data

        const originalData = window.strainEnergyResults;
        const normalizedZ = {};
        const Z0 = originalData.Z0 || 0;

        for (const id in originalData.z) {
            normalizedZ[id] = originalData.z[id] < Z0 ? 0 : originalData.z[id];
        }

        const normalizedChartData = {
            ...originalData,
            z: normalizedZ
        };

        drawStyled3DBarChart('normalized3DChart_section1', normalizedChartData, 'Biểu đồ 3D chuẩn hóa - Vị trí hư hỏng', { showPercentages: false, zAxisRange: [0, 10], zAspect: 1 });
      }

    </script>

    <!-- Bộ điều khiển ẩn/hiện nhanh — dời xuống cuối trang -->
    <div class="container d-flex justify-content-end align-items-center" style="margin: 10px 0;">
      <div class="ui-visibility-wrap">
        <button id="ui-visibility-toggle-btn" class="btn btn-outline-secondary btn-sm" type="button"
                aria-haspopup="true" aria-controls="ui-visibility-menu" aria-expanded="false"
                title="Ẩn/hiện nhanh các mục giao diện">
          Tùy chọn hiển thị
        </button>
        <div id="ui-visibility-menu" class="dropdown-menu p-2" role="menu" aria-labelledby="ui-visibility-toggle-btn">
          <div class="form-check" role="menuitem">
            <input class="form-check-input" type="checkbox" id="chk-hide-action-buttons" aria-controls="action-buttons-container" />
            <label class="form-check-label" for="chk-hide-action-buttons">Ẩn nhóm nút hành động</label>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
